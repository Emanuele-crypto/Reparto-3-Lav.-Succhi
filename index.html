<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Gestione Produzione Agrumi - Reparto 3</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
        }
        .header {
            background-color: #198754;
            color: white;
            padding: 15px 0;
            margin-bottom: 30px;
        }
        .card {
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .card-header {
            background-color: #e7f5ee;
            font-weight: bold;
        }
        .stats-card {
            text-align: center;
            padding: 15px;
        }
        .stats-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #198754;
        }
        .section-card {
            height: 100%;
            transition: all 0.3s;
        }
        .section-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        .btn-custom {
            background-color: #198754;
            color: white;
        }
        .btn-custom:hover {
            background-color: #146c43;
            color: white;
        }
        .section-header {
            background-color: #e7f5ee;
            text-align: center;
            font-weight: bold;
            padding: 10px 0;
            margin-bottom: 15px;
            border-radius: 5px;
        }
        .required-field::after {
            content: " *";
            color: red;
        }
        .nav-tabs .nav-link.active {
            background-color: #e7f5ee;
            border-color: #198754 #198754 #e7f5ee;
            color: #198754;
            font-weight: bold;
        }
        .nav-tabs .nav-link {
            color: #495057;
        }
        .machine-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }
        .machine-card:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        .machine-card.selected {
            border: 2px solid #198754;
            background-color: #e7f5ee;
        }
        .machine-title {
            font-weight: bold;
            margin-bottom: 10px;
        }
        .machine-status {
            font-size: 0.9rem;
            margin-bottom: 5px;
        }
        .badge-status {
            font-size: 0.8rem;
            padding: 5px 8px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h1><i class="bi bi-droplet-fill"></i> Reparto 3 - Lavorazione Succhi</h1>
                </div>
                <div class="col-md-6 text-end">
                    <div class="btn-group">
                        <button class="btn btn-light" id="btn-reparto-1">
                            <i class="bi bi-arrow-left-circle"></i> Reparto 1: Ricezione e scarico frutta
                        </button>
                        <button class="btn btn-light" id="btn-reparto-2">
                            <i class="bi bi-arrow-left-circle"></i> Reparto 2: Trasformazione
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container mb-5">
        <!-- Statistiche -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="stats-value" id="total-concentrato">0 L</div>
                    <div>Succo Concentrato</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="stats-value" id="total-distillato">0 L</div>
                    <div>Prodotto Distillato</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="stats-value" id="total-pastorizzato">0 L</div>
                    <div>Prodotto Pastorizzato</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="stats-value" id="processi-attivi">0</div>
                    <div>Processi Attivi</div>
                </div>
            </div>
        </div>

        <!-- Tabs per sotto-reparti -->
        <ul class="nav nav-tabs mb-4" id="sub-dept-tabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="concentratori-tab" data-bs-toggle="tab" data-bs-target="#concentratori-content" type="button" role="tab">Concentratori</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="distillatori-tab" data-bs-toggle="tab" data-bs-target="#distillatori-content" type="button" role="tab">Distillatori</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="pastorizzatori-tab" data-bs-toggle="tab" data-bs-target="#pastorizzatori-content" type="button" role="tab">Pastorizzatori</button>
            </li>
        </ul>
        
        <div class="tab-content">
            <!-- Concentratori -->
            <div class="tab-pane fade show active" id="concentratori-content" role="tabpanel">
                <div class="row">
                    <div class="col-md-12">
                        <div class="section-header">
                            <h4>Concentratori</h4>
                        </div>
                    </div>
                </div>
                
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h5 class="mb-3">Seleziona Impianto</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="machine-card" id="machine-APV1">
                                    <div class="machine-title">APV1</div>
                                    <div class="machine-status">Stato: <span class="badge bg-success badge-status">Disponibile</span></div>
                                    <div class="machine-status">Capacità: 4800 L/h</div>
                                    <div class="text-end mt-2">
                                        <button class="btn btn-sm btn-outline-success select-machine-btn" data-machine="APV1" data-type="concentratore">Seleziona</button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="machine-card" id="machine-APV2">
                                    <div class="machine-title">APV2</div>
                                    <div class="machine-status">Stato: <span class="badge bg-success badge-status">Disponibile</span></div>
                                    <div class="machine-status">Capacità: 4200 L/h</div>
                                    <div class="text-end mt-2">
                                        <button class="btn btn-sm btn-outline-success select-machine-btn" data-machine="APV2" data-type="concentratore">Seleziona</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <h5 class="mb-3">Etichetta Serbatoio da Concentrare</h5>
                        <form id="concentrazione-form">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="conc-tipo-prodotto" class="form-label required-field">Tipo Prodotto</label>
                                    <select class="form-select" id="conc-tipo-prodotto" required>
                                        <option value="" selected disabled>Seleziona...</option>
                                        <option value="Succo">Succo</option>
                                        <option value="Torchiato">Torchiato</option>
                                        <option value="Estratto">Estratto</option>
                                        <option value="Altro">Altro</option>
                                    </select>
                                    <div id="conc-altro-prodotto-container" style="display: none;" class="mt-2">
                                        <input type="text" class="form-control" id="conc-altro-prodotto" placeholder="Specifica altro prodotto">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label for="conc-serbatoio" class="form-label required-field">Serbatoio</label>
                                    <select class="form-select" id="conc-serbatoio" required>
                                        <option value="" selected disabled>Seleziona...</option>
                                        <optgroup label="SERB AZZ">
                                            <option value="1Azz">1 Azz</option>
                                            <option value="2Azz">2 Azz</option>
                                            <option value="3Azz">3 Azz</option>
                                            <option value="4Azz">4 Azz</option>
                                            <option value="5Azz">5 Azz</option>
                                            <option value="6Azz">6 Azz</option>
                                            <option value="7Azz">7 Azz</option>
                                            <option value="8Azz">8 Azz</option>
                                            <option value="9Azz">9 Azz</option>
                                            <option value="10Azz">10 Azz</option>
                                        </optgroup>
                                        <optgroup label="SERB 11000">
                                            <option value="S21">S21</option>
                                            <option value="S22">S22</option>
                                            <option value="S23">S23</option>
                                            <option value="S24">S24</option>
                                            <option value="S25">S25</option>
                                            <option value="S26">S26</option>
                                            <option value="S27">S27</option>
                                            <option value="S28">S28</option>
                                            <option value="S29">S29</option>
                                            <option value="S30">S30</option>
                                        </optgroup>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="conc-tipo-agrume" class="form-label required-field">Tipo Agrume</label>
                                    <select class="form-select" id="conc-tipo-agrume" required>
                                        <option value="" selected disabled>Seleziona...</option>
                                        <option value="Arance">Arance</option>
                                        <option value="Arance Rosse">Arance Rosse</option>
                                        <option value="Limoni">Limoni</option>
                                        <option value="Mandarini">Mandarini</option>
                                        <option value="Pompelmi">Pompelmi</option>
                                        <option value="Altro">Altro</option>
                                    </select>
                                    <div id="conc-altro-agrume-container" style="display: none;" class="mt-2">
                                        <input type="text" class="form-control" id="conc-altro-agrume" placeholder="Specifica altro agrume">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label for="conc-certificazione" class="form-label required-field">Certificazione</label>
                                    <select class="form-select" id="conc-certificazione" required>
                                        <option value="" selected disabled>Seleziona...</option>
                                        <option value="BIO EU">BIO EU</option>
                                        <option value="BIO DEMETER">BIO DEMETER</option>
                                        <option value="CONVENZIONALE">CONVENZIONALE</option>
                                        <option value="IGP">IGP</option>
                                        <option value="ALTRO">ALTRO</option>
                                    </select>
                                    <div id="conc-altra-certificazione-container" style="display: none;" class="mt-2">
                                        <input type="text" class="form-control" id="conc-altra-certificazione" placeholder="Specifica altra certificazione">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="conc-linea-trasformazione" class="form-label required-field">Linea di Trasformazione</label>
                                    <select class="form-select" id="conc-linea-trasformazione" required>
                                        <option value="" selected disabled>Seleziona...</option>
                                        <option value="BOE">BOE</option>
                                        <option value="GOE INT">GOE INT</option>
                                        <option value="B/SF">B/SF</option>
                                        <option value="400">400</option>
                                        <option value="ALTRA">ALTRA</option>
                                    </select>
                                    <div id="conc-altra-linea-container" style="display: none;" class="mt-2">
                                        <input type="text" class="form-control" id="conc-altra-linea" placeholder="Specifica altra linea">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label for="conc-tenore-polpa" class="form-label required-field">Tenore di Polpa</label>
                                    <select class="form-select" id="conc-tenore-polpa" required>
                                        <option value="" selected disabled>Seleziona...</option>
                                        <option value="Limpido">Limpido</option>
                                        <option value="Semiclear">Semiclear</option>
                                        <option value="> 1%">> 1%</option>
                                        <option value="Standard">Standard</option>
                                        <option value="Altro">Altro</option>
                                    </select>
                                    <div id="conc-altro-tenore-container" style="display: none;" class="mt-2">
                                        <input type="text" class="form-control" id="conc-altro-tenore" placeholder="Specifica altro tenore">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="conc-quantita" class="form-label required-field">Quantità concentrato prodotta (L)</label>
                                    <input type="number" class="form-control" id="conc-quantita" required min="1">
                                </div>
                                <div class="col-md-6">
                                    <label for="conc-note" class="form-label">Note</label>
                                    <textarea class="form-control" id="conc-note" rows="2"></textarea>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="conc-brix-target" class="form-label required-field">Brix Target</label>
                                    <input type="number" class="form-control" id="conc-brix-target" required step="0.1" min="0">
                                </div>
                            </div>
                            
                            <div class="text-end mt-4">
                                <button type="button" class="btn btn-secondary me-2" id="conc-btn-reset">
                                    <i class="bi bi-x-circle"></i> Annulla
                                </button>
                                <button type="submit" class="btn btn-custom">
                                    <i class="bi bi-play-circle"></i> Avvia Concentrazione
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                <i class="bi bi-list-check"></i> Processi di Concentrazione in Corso
                            </div>
                            <div class="card-body">
                                <table class="table table-striped table-bordered">
                                    <thead>
                                        <tr>
                                            <th>ID Processo</th>
                                            <th>Impianto</th>
                                            <th>Serbatoio</th>
                                            <th>Prodotto</th>
                                            <th>Agrume</th>
                                            <th>Certificazione</th>
                                            <th>Quantità</th>
                                            <th>Brix Target</th>
                                            <th>Stato</th>
                                            <th>Azioni</th>
                                        </tr>
                                    </thead>
                                    <tbody id="concentrazione-processi">
                                        <tr>
                                            <td colspan="10" class="text-center">Nessun processo attivo</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Distillatori -->
            <div class="tab-pane fade" id="distillatori-content" role="tabpanel">
                <div class="row">
                    <div class="col-md-12">
                        <div class="section-header">
                            <h4>Distillatori</h4>
                        </div>
                    </div>
                </div>
                
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h5 class="mb-3">Seleziona Impianto</h5>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <div class="machine-card" id="machine-Santoro">
                                    <div class="machine-title">Santoro</div>
                                    <div class="machine-status">Stato: <span class="badge bg-success badge-status">Disponibile</span></div>
                                    <div class="machine-status">Capacità: 4200 L/h</div>
                                    <div class="text-end mt-2">
                                        <button class="btn btn-sm btn-outline-success select-machine-btn" data-machine="Santoro" data-type="distillatore">Seleziona</button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="machine-card" id="machine-Padovan">
                                    <div class="machine-title">Padovan</div>
                                    <div class="machine-status">Stato: <span class="badge bg-success badge-status">Disponibile</span></div>
                                    <div class="machine-status">Capacità: 5000 L/h</div>
                                    <div class="text-end mt-2">
                                        <button class="btn btn-sm btn-outline-success select-machine-btn" data-machine="Padovan" data-type="distillatore">Seleziona</button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="machine-card" id="machine-Pilato1">
                                    <div class="machine-title">Pilato 1</div>
                                    <div class="machine-status">Stato: <span class="badge bg-success badge-status">Disponibile</span></div>
                                    <div class="machine-status">Capacità: 1000 L/h</div>
                                    <div class="text-end mt-2">
                                        <button class="btn btn-sm btn-outline-success select-machine-btn" data-machine="Pilato1" data-type="distillatore">Seleziona</button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="machine-card" id="machine-Pilato2">
                                    <div class="machine-title">Pilato 2</div>
                                    <div class="machine-status">Stato: <span class="badge bg-success badge-status">Disponibile</span></div>
                                    <div class="machine-status">Capacità: 1000 L/h</div>
                                    <div class="text-end mt-2">
                                        <button class="btn btn-sm btn-outline-success select-machine-btn" data-machine="Pilato2" data-type="distillatore">Seleziona</button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="machine-card" id="machine-Joe">
                                    <div class="machine-title">Joe</div>
                                    <div class="machine-status">Stato: <span class="badge bg-success badge-status">Disponibile</span></div>
                                    <div class="machine-status">Capacità: 2300 L/h</div>
                                    <div class="text-end mt-2">
                                        <button class="btn btn-sm btn-outline-success select-machine-btn" data-machine="Joe" data-type="distillatore">Seleziona</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <h5 class="mb-3">Etichetta Serbatoio da Distillare</h5>
                        <form id="distillazione-form">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="dist-tipo-prodotto" class="form-label required-field">Tipo Prodotto</label>
                                    <select class="form-select" id="dist-tipo-prodotto" required>
                                        <option value="" selected disabled>Seleziona...</option>
                                        <option value="Succo">Succo</option>
                                        <option value="Torchiato">Torchiato</option>
                                        <option value="Estratto">Estratto</option>
                                        <option value="Altro">Altro</option>
                                    </select>
                                    <div id="dist-altro-prodotto-container" style="display: none;" class="mt-2">
                                        <input type="text" class="form-control" id="dist-altro-prodotto" placeholder="Specifica altro prodotto">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label for="dist-serbatoio" class="form-label required-field">Serbatoio</label>
                                    <select class="form-select" id="dist-serbatoio" required>
                                        <option value="" selected disabled>Seleziona...</option>
                                        <optgroup label="SERB AZZ">
                                            <option value="1Azz">1 Azz</option>
                                            <option value="2Azz">2 Azz</option>
                                            <option value="3Azz">3 Azz</option>
                                            <option value="4Azz">4 Azz</option>
                                            <option value="5Azz">5 Azz</option>
                                            <option value="6Azz">6 Azz</option>
                                            <option value="7Azz">7 Azz</option>
                                            <option value="8Azz">8 Azz</option>
                                            <option value="9Azz">9 Azz</option>
                                            <option value="10Azz">10 Azz</option>
                                        </optgroup>
                                        <optgroup label="SERB 11000">
                                            <option value="S21">S21</option>
                                            <option value="S22">S22</option>
                                            <option value="S23">S23</option>
                                            <option value="S24">S24</option>
                                            <option value="S25">S25</option>
                                            <option value="S26">S26</option>
                                            <option value="S27">S27</option>
                                            <option value="S28">S28</option>
                                            <option value="S29">S29</option>
                                            <option value="S30">S30</option>
                                        </optgroup>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="dist-tipo-agrume" class="form-label required-field">Tipo Agrume</label>
                                    <select class="form-select" id="dist-tipo-agrume" required>
                                        <option value="" selected disabled>Seleziona...</option>
                                        <option value="Arance">Arance</option>
                                        <option value="Arance Rosse">Arance Rosse</option>
                                        <option value="Limoni">Limoni</option>
                                        <option value="Mandarini">Mandarini</option>
                                        <option value="Pompelmi">Pompelmi</option>
                                        <option value="Altro">Altro</option>
                                    </select>
                                    <div id="dist-altro-agrume-container" style="display: none;" class="mt-2">
                                        <input type="text" class="form-control" id="dist-altro-agrume" placeholder="Specifica altro agrume">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label for="dist-certificazione" class="form-label required-field">Certificazione</label>
                                    <select class="form-select" id="dist-certificazione" required>
                                        <option value="" selected disabled>Seleziona...</option>
                                        <option value="BIO EU">BIO EU</option>
                                        <option value="BIO DEMETER">BIO DEMETER</option>
                                        <option value="CONVENZIONALE">CONVENZIONALE</option>
                                        <option value="IGP">IGP</option>
                                        <option value="ALTRO">ALTRO</option>
                                    </select>
                                    <div id="dist-altra-certificazione-container" style="display: none;" class="mt-2">
                                        <input type="text" class="form-control" id="dist-altra-certificazione" placeholder="Specifica altra certificazione">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="dist-linea-trasformazione" class="form-label required-field">Linea di Trasformazione</label>
                                    <select class="form-select" id="dist-linea-trasformazione" required>
                                        <option value="" selected disabled>Seleziona...</option>
                                        <option value="BOE">BOE</option>
                                        <option value="GOE INT">GOE INT</option>
                                        <option value="B/SF">B/SF</option>
                                        <option value="400">400</option>
                                        <option value="ALTRA">ALTRA</option>
                                    </select>
                                    <div id="dist-altra-linea-container" style="display: none;" class="mt-2">
                                        <input type="text" class="form-control" id="dist-altra-linea" placeholder="Specifica altra linea">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label for="dist-tenore-polpa" class="form-label required-field">Tenore di Polpa</label>
                                    <select class="form-select" id="dist-tenore-polpa" required>
                                        <option value="" selected disabled>Seleziona...</option>
                                        <option value="Limpido">Limpido</option>
                                        <option value="Semiclear">Semiclear</option>
                                        <option value="> 1%">> 1%</option>
                                        <option value="Standard">Standard</option>
                                        <option value="Altro">Altro</option>
                                    </select>
                                    <div id="dist-altro-tenore-container" style="display: none;" class="mt-2">
                                        <input type="text" class="form-control" id="dist-altro-tenore" placeholder="Specifica altro tenore">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="dist-quantita" class="form-label required-field">Quantità concentrato prodotta (L)</label>
                                    <input type="number" class="form-control" id="dist-quantita" required min="1">
                                </div>
                                <div class="col-md-6">
                                    <label for="dist-note" class="form-label">Note</label>
                                    <textarea class="form-control" id="dist-note" rows="2"></textarea>
                                </div>
                            </div>
                            
                            <div class="text-end mt-4">
                                <button type="button" class="btn btn-secondary me-2" id="dist-btn-reset">
                                    <i class="bi bi-x-circle"></i> Annulla
                                </button>
                                <button type="submit" class="btn btn-custom">
                                    <i class="bi bi-play-circle"></i> Avvia Distillazione
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                <i class="bi bi-list-check"></i> Processi di Distillazione in Corso
                            </div>
                            <div class="card-body">
                                <table class="table table-striped table-bordered">
                                    <thead>
                                        <tr>
                                            <th>ID Processo</th>
                                            <th>Impianto</th>
                                            <th>Serbatoio</th>
                                            <th>Prodotto</th>
                                            <th>Agrume</th>
                                            <th>Certificazione</th>
                                            <th>Quantità</th>
                                            <th>Stato</th>
                                            <th>Azioni</th>
                                        </tr>
                                    </thead>
                                    <tbody id="distillazione-processi">
                                        <tr>
                                            <td colspan="9" class="text-center">Nessun processo attivo</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Pastorizzatori -->
            <div class="tab-pane fade" id="pastorizzatori-content" role="tabpanel">
                <div class="row">
                    <div class="col-md-12">
                        <div class="section-header">
                            <h4>Pastorizzatori</h4>
                        </div>
                    </div>
                </div>
                
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h5 class="mb-3">Seleziona Impianto</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="machine-card" id="machine-PastArancia">
                                    <div class="machine-title">Pastorizzatore Arancia</div>
                                    <div class="machine-status">Stato: <span class="badge bg-success badge-status">Disponibile</span></div>
                                    <div class="machine-status">Capacità: 3000 L/h</div>
                                    <div class="text-end mt-2">
                                        <button class="btn btn-sm btn-outline-success select-machine-btn" data-machine="PastArancia" data-type="pastorizzatore">Seleziona</button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="machine-card" id="machine-PastProfea">
                                    <div class="machine-title">Pastorizzatore Profea</div>
                                    <div class="machine-status">Stato: <span class="badge bg-success badge-status">Disponibile</span></div>
                                    <div class="machine-status">Capacità: 4000 L/h</div>
                                    <div class="text-end mt-2">
                                        <button class="btn btn-sm btn-outline-success select-machine-btn" data-machine="PastProfea" data-type="pastorizzatore">Seleziona</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <h5 class="mb-3">Etichetta Serbatoio da Pastorizzare</h5>
                        <form id="pastorizzazione-form">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="past-tipo-prodotto" class="form-label required-field">Tipo Prodotto</label>
                                    <select class="form-select" id="past-tipo-prodotto" required>
                                        <option value="" selected disabled>Seleziona...</option>
                                        <option value="Succo">Succo</option>
                                        <option value="Torchiato">Torchiato</option>
                                        <option value="Estratto">Estratto</option>
                                        <option value="Altro">Altro</option>
                                    </select>
                                    <div id="past-altro-prodotto-container" style="display: none;" class="mt-2">
                                        <input type="text" class="form-control" id="past-altro-prodotto" placeholder="Specifica altro prodotto">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label for="past-serbatoio" class="form-label required-field">Serbatoio</label>
                                    <select class="form-select" id="past-serbatoio" required>
                                        <option value="" selected disabled>Seleziona...</option>
                                        <optgroup label="SERB AZZ">
                                            <option value="1Azz">1 Azz</option>
                                            <option value="2Azz">2 Azz</option>
                                            <option value="3Azz">3 Azz</option>
                                            <option value="4Azz">4 Azz</option>
                                            <option value="5Azz">5 Azz</option>
                                            <option value="6Azz">6 Azz</option>
                                            <option value="7Azz">7 Azz</option>
                                            <option value="8Azz">8 Azz</option>
                                            <option value="9Azz">9 Azz</option>
                                            <option value="10Azz">10 Azz</option>
                                        </optgroup>
                                        <optgroup label="SERB 11000">
                                            <option value="S21">S21</option>
                                            <option value="S22">S22</option>
                                            <option value="S23">S23</option>
                                            <option value="S24">S24</option>
                                            <option value="S25">S25</option>
                                            <option value="S26">S26</option>
                                            <option value="S27">S27</option>
                                            <option value="S28">S28</option>
                                            <option value="S29">S29</option>
                                            <option value="S30">S30</option>
                                        </optgroup>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="past-tipo-agrume" class="form-label required-field">Tipo Agrume</label>
                                    <select class="form-select" id="past-tipo-agrume" required>
                                        <option value="" selected disabled>Seleziona...</option>
                                        <option value="Arance">Arance</option>
                                        <option value="Arance Rosse">Arance Rosse</option>
                                        <option value="Limoni">Limoni</option>
                                        <option value="Mandarini">Mandarini</option>
                                        <option value="Pompelmi">Pompelmi</option>
                                        <option value="Altro">Altro</option>
                                    </select>
                                    <div id="past-altro-agrume-container" style="display: none;" class="mt-2">
                                        <input type="text" class="form-control" id="past-altro-agrume" placeholder="Specifica altro agrume">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label for="past-certificazione" class="form-label required-field">Certificazione</label>
                                    <select class="form-select" id="past-certificazione" required>
                                        <option value="" selected disabled>Seleziona...</option>
                                        <option value="BIO EU">BIO EU</option>
                                        <option value="BIO DEMETER">BIO DEMETER</option>
                                        <option value="CONVENZIONALE">CONVENZIONALE</option>
                                        <option value="IGP">IGP</option>
                                        <option value="ALTRO">ALTRO</option>
                                    </select>
                                    <div id="past-altra-certificazione-container" style="display: none;" class="mt-2">
                                        <input type="text" class="form-control" id="past-altra-certificazione" placeholder="Specifica altra certificazione">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="past-linea-trasformazione" class="form-label required-field">Linea di Trasformazione</label>
                                    <select class="form-select" id="past-linea-trasformazione" required>
                                        <option value="" selected disabled>Seleziona...</option>
                                        <option value="BOE">BOE</option>
                                        <option value="GOE INT">GOE INT</option>
                                        <option value="B/SF">B/SF</option>
                                        <option value="400">400</option>
                                        <option value="ALTRA">ALTRA</option>
                                    </select>
                                    <div id="past-altra-linea-container" style="display: none;" class="mt-2">
                                        <input type="text" class="form-control" id="past-altra-linea" placeholder="Specifica altra linea">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label for="past-tenore-polpa" class="form-label required-field">Tenore di Polpa</label>
                                    <select class="form-select" id="past-tenore-polpa" required>
                                        <option value="" selected disabled>Seleziona...</option>
                                        <option value="Limpido">Limpido</option>
                                        <option value="Semiclear">Semiclear</option>
                                        <option value="> 1%">> 1%</option>
                                        <option value="Standard">Standard</option>
                                        <option value="Altro">Altro</option>
                                    </select>
                                    <div id="past-altro-tenore-container" style="display: none;" class="mt-2">
                                        <input type="text" class="form-control" id="past-altro-tenore" placeholder="Specifica altro tenore">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="past-quantita" class="form-label required-field">Quantità concentrato prodotta (L)</label>
                                    <input type="number" class="form-control" id="past-quantita" required min="1">
                                </div>
                                <div class="col-md-6">
                                    <label for="past-note" class="form-label">Note</label>
                                    <textarea class="form-control" id="past-note" rows="2"></textarea>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="past-temperatura" class="form-label required-field">Temperatura (°C)</label>
                                    <input type="number" class="form-control" id="past-temperatura" required step="0.1" min="0">
                                </div>
                                <div class="col-md-6">
                                    <label for="past-tempo" class="form-label required-field">Tempo (min)</label>
                                    <input type="number" class="form-control" id="past-tempo" required step="0.1" min="0">
                                </div>
                            </div>
                            
                            <div class="text-end mt-4">
                                <button type="button" class="btn btn-secondary me-2" id="past-btn-reset">
                                    <i class="bi bi-x-circle"></i> Annulla
                                </button>
                                <button type="submit" class="btn btn-custom">
                                    <i class="bi bi-play-circle"></i> Avvia Pastorizzazione
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                <i class="bi bi-list-check"></i> Processi di Pastorizzazione in Corso
                            </div>
                            <div class="card-body">
                                <table class="table table-striped table-bordered">
                                    <thead>
                                        <tr>
                                            <th>ID Processo</th>
                                            <th>Impianto</th>
                                            <th>Serbatoio</th>
                                            <th>Prodotto</th>
                                            <th>Agrume</th>
                                            <th>Certificazione</th>
                                            <th>Quantità</th>
                                            <th>Temperatura</th>
                                            <th>Tempo</th>
                                            <th>Stato</th>
                                            <th>Azioni</th>
                                        </tr>
                                    </thead>
                                    <tbody id="pastorizzazione-processi">
                                        <tr>
                                            <td colspan="11" class="text-center">Nessun processo attivo</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Stato Processo -->
    <div class="modal fade" id="processoModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-light">
                    <h5 class="modal-title"><i class="bi bi-gear"></i> Dettagli Processo <span id="processo-id"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p><strong>Impianto:</strong> <span id="modal-macchina"></span></p>
                            <p><strong>Serbatoio:</strong> <span id="modal-serbatoio"></span></p>
                            <p><strong>Prodotto:</strong> <span id="modal-prodotto"></span></p>
                            <p><strong>Agrume:</strong> <span id="modal-agrume"></span></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Certificazione:</strong> <span id="modal-certificazione"></span></p>
                            <p><strong>Quantità:</strong> <span id="modal-quantita"></span></p>
                            <p><strong>Linea di Trasformazione:</strong> <span id="modal-linea"></span></p>
                            <p><strong>Data Inizio:</strong> <span id="modal-data-inizio"></span></p>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <p><strong>Note:</strong> <span id="modal-note"></span></p>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <form id="processo-update-form">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="modal-stato" class="form-label">Aggiorna Stato</label>
                                <select class="form-select" id="modal-stato">
                                    <option value="In corso">In corso</option>
                                    <option value="Completato">Completato</option>
                                    <option value="Interrotto">Interrotto</option>
                                    <option value="In pausa">In pausa</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="modal-avanzamento" class="form-label">Avanzamento (%)</label>
                                <input type="range" class="form-range" id="modal-avanzamento" min="0" max="100" step="5">
                                <div class="text-center" id="modal-avanzamento-valore">50%</div>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <label for="modal-note-aggiuntive" class="form-label">Note Aggiuntive</label>
                                <textarea class="form-control" id="modal-note-aggiuntive" rows="3"></textarea>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
                    <button type="button" class="btn btn-custom" id="btn-save-process">Salva Modifiche</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Script JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script>
        $(document).ready(function() {
            // Dati globali
            let selectedMachine = null;
            let selectedMachineType = null;
            let currentProcessId = null;
            let processi = {
                concentrazione: {},
                distillazione: {},
                pastorizzazione: {}
            };
            
            // Statistiche
            let stats = {
                concentrato: 0,
                distillato: 0,
                pastorizzato: 0,
                processiAttivi: 0
            };
            
            // Gestione selezione macchina
            $(document).on("click", ".select-machine-btn", function() {
                const machineId = $(this).data("machine");
                const machineType = $(this).data("type");
                
                console.log("Pulsante selezionato per macchina:", machineId, "tipo:", machineType);
                
                // Deseleziona tutte le macchine nella stessa sezione
                $(`.machine-card`).removeClass("selected");
                
                // Seleziona questa macchina
                $(`#machine-${machineId}`).addClass("selected");
                
                // Memorizza la macchina selezionata
                selectedMachine = machineId;
                selectedMachineType = machineType;
                
                console.log("Macchina selezionata:", selectedMachine, "Tipo:", selectedMachineType);
            });
            
            // Gestione form concentrazione
            $("#conc-tipo-prodotto").change(function() {
                if ($(this).val() === "Altro") {
                    $("#conc-altro-prodotto-container").show();
                } else {
                    $("#conc-altro-prodotto-container").hide();
                    $("#conc-altro-prodotto").val("");
                }
            });
            
            $("#conc-tipo-agrume").change(function() {
                if ($(this).val() === "Altro") {
                    $("#conc-altro-agrume-container").show();
                } else {
                    $("#conc-altro-agrume-container").hide();
                    $("#conc-altro-agrume").val("");
                }
            });
            
            $("#conc-certificazione").change(function() {
                if ($(this).val() === "ALTRO") {
                    $("#conc-altra-certificazione-container").show();
                } else {
                    $("#conc-altra-certificazione-container").hide();
                    $("#conc-altra-certificazione").val("");
                }
            });
            
            $("#conc-linea-trasformazione").change(function() {
                if ($(this).val() === "ALTRA") {
                    $("#conc-altra-linea-container").show();
                } else {
                    $("#conc-altra-linea-container").hide();
                    $("#conc-altra-linea").val("");
                }
            });
            
            $("#conc-tenore-polpa").change(function() {
                if ($(this).val() === "Altro") {
                    $("#conc-altro-tenore-container").show();
                } else {
                    $("#conc-altro-tenore-container").hide();
                    $("#conc-altro-tenore").val("");
                }
            });
            
            // Reset form concentrazione
            $("#conc-btn-reset").click(function() {
                if (confirm("Annullare il processo? I dati inseriti andranno persi.")) {
                    $("#concentrazione-form")[0].reset();
                    $("[id^='conc-altro-'][id$='-container']").hide();
                    $("#concentratori-content .machine-card").removeClass("selected");
                    selectedMachine = null;
                    selectedMachineType = null;
                }
            });
            
            // Gestione form distillazione
            $("#dist-tipo-prodotto").change(function() {
                if ($(this).val() === "Altro") {
                    $("#dist-altro-prodotto-container").show();
                } else {
                    $("#dist-altro-prodotto-container").hide();
                    $("#dist-altro-prodotto").val("");
                }
            });
            
            $("#dist-tipo-agrume").change(function() {
                if ($(this).val() === "Altro") {
                    $("#dist-altro-agrume-container").show();
                } else {
                    $("#dist-altro-agrume-container").hide();
                    $("#dist-altro-agrume").val("");
                }
            });
            
            $("#dist-certificazione").change(function() {
                if ($(this).val() === "ALTRO") {
                    $("#dist-altra-certificazione-container").show();
                } else {
                    $("#dist-altra-certificazione-container").hide();
                    $("#dist-altra-certificazione").val("");
                }
            });
            
            $("#dist-linea-trasformazione").change(function() {
                if ($(this).val() === "ALTRA") {
                    $("#dist-altra-linea-container").show();
                } else {
                    $("#dist-altra-linea-container").hide();
                    $("#dist-altra-linea").val("");
                }
            });
            
            $("#dist-tenore-polpa").change(function() {
                if ($(this).val() === "Altro") {
                    $("#dist-altro-tenore-container").show();
                } else {
                    $("#dist-altro-tenore-container").hide();
                    $("#dist-altro-tenore").val("");
                }
            });
            
            // Reset form distillazione
            $("#dist-btn-reset").click(function() {
                if (confirm("Annullare il processo? I dati inseriti andranno persi.")) {
                    $("#distillazione-form")[0].reset();
                    $("[id^='dist-altro-'][id$='-container']").hide();
                    $("#distillatori-content .machine-card").removeClass("selected");
                    selectedMachine = null;
                    selectedMachineType = null;
                }
            });
            
            // Gestione form pastorizzazione
            $("#past-tipo-prodotto").change(function() {
                if ($(this).val() === "Altro") {
                    $("#past-altro-prodotto-container").show();
                } else {
                    $("#past-altro-prodotto-container").hide();
                    $("#past-altro-prodotto").val("");
                }
            });
            
            $("#past-tipo-agrume").change(function() {
                if ($(this).val() === "Altro") {
                    $("#past-altro-agrume-container").show();
                } else {
                    $("#past-altro-agrume-container").hide();
                    $("#past-altro-agrume").val("");
                }
            });
            
            $("#past-certificazione").change(function() {
                if ($(this).val() === "ALTRO") {
                    $("#past-altra-certificazione-container").show();
                } else {
                    $("#past-altra-certificazione-container").hide();
                    $("#past-altra-certificazione").val("");
                }
            });
            
            $("#past-linea-trasformazione").change(function() {
                if ($(this).val() === "ALTRA") {
                    $("#past-altra-linea-container").show();
                } else {
                    $("#past-altra-linea-container").hide();
                    $("#past-altra-linea").val("");
                }
            });
            
            $("#past-tenore-polpa").change(function() {
                if ($(this).val() === "Altro") {
                    $("#past-altro-tenore-container").show();
                } else {
                    $("#past-altro-tenore-container").hide();
                    $("#past-altro-tenore").val("");
                }
            });
            
            // Reset form pastorizzazione
            $("#past-btn-reset").click(function() {
                if (confirm("Annullare il processo? I dati inseriti andranno persi.")) {
                    $("#pastorizzazione-form")[0].reset();
                    $("[id^='past-altro-'][id$='-container']").hide();
                    $("#pastorizzatori-content .machine-card").removeClass("selected");
                    selectedMachine = null;
                    selectedMachineType = null;
                }
            });
            
            // Avvio processo di concentrazione
            $("#concentrazione-form").submit(function(e) {
                e.preventDefault();
                
                console.log("Form concentrazione inviato");
                
                // Verifica che sia stata selezionata una macchina
                if (!selectedMachine || selectedMachineType !== "concentratore") {
                    alert("Seleziona un impianto di concentrazione!");
                    return;
                }
                
                // Raccolta dati
                let tipoProdotto = $("#conc-tipo-prodotto").val();
                if (tipoProdotto === "Altro") {
                    tipoProdotto = $("#conc-altro-prodotto").val();
                    if (!tipoProdotto) {
                        alert("Specifica il tipo di prodotto!");
                        return;
                    }
                }
                
                let serbatoio = $("#conc-serbatoio").val();
                if (!serbatoio) {
                    alert("Seleziona un serbatoio!");
                    return;
                }
                
                let tipoAgrume = $("#conc-tipo-agrume").val();
                if (tipoAgrume === "Altro") {
                    tipoAgrume = $("#conc-altro-agrume").val();
                    if (!tipoAgrume) {
                        alert("Specifica il tipo di agrume!");
                        return;
                    }
                }
                
                let certificazione = $("#conc-certificazione").val();
                if (certificazione === "ALTRO") {
                    certificazione = $("#conc-altra-certificazione").val();
                    if (!certificazione) {
                        alert("Specifica la certificazione!");
                        return;
                    }
                }
                
                let lineaTrasformazione = $("#conc-linea-trasformazione").val();
                if (lineaTrasformazione === "ALTRA") {
                    lineaTrasformazione = $("#conc-altra-linea").val();
                    if (!lineaTrasformazione) {
                        alert("Specifica la linea di trasformazione!");
                        return;
                    }
                }
                
                let tenorePolpa = $("#conc-tenore-polpa").val();
                if (tenorePolpa === "Altro") {
                    tenorePolpa = $("#conc-altro-tenore").val();
                    if (!tenorePolpa) {
                        alert("Specifica il tenore di polpa!");
                        return;
                    }
                }
                
                const quantita = parseInt($("#conc-quantita").val());
                const brixTarget = parseFloat($("#conc-brix-target").val());
                const note = $("#conc-note").val();
                
                                             // Validazione 
                if (!tipoProdotto || !tipoAgrume || !certificazione || 
                    !lineaTrasformazione || !tenorePolpa || isNaN(quantita) || 
                    isNaN(brixTarget)) {
                    alert("Compila tutti i campi obbligatori con valori validi!");
                    return;
                }
                
                // Generazione ID processo
                const now = new Date();
                const processId = "CONC-" + now.getFullYear() + 
                               padZero(now.getMonth() + 1) + 
                               padZero(now.getDate()) + "-" + 
                               padZero(now.getHours()) + 
                               padZero(now.getMinutes()) +
                               padZero(now.getSeconds());
                
                console.log("Creazione processo:", processId);
                
                // Creazione oggetto processo
                processi.concentrazione[processId] = {
                    id: processId,
                    macchina: selectedMachine,
                    serbatoio: serbatoio,
                    tipoProdotto: tipoProdotto,
                    tipoAgrume: tipoAgrume,
                    certificazione: certificazione,
                    lineaTrasformazione: lineaTrasformazione,
                    tenorePolpa: tenorePolpa,
                    quantita: quantita,
                    brixTarget: brixTarget,
                    note: note,
                    stato: "In corso",
                    avanzamento: 0,
                    dataInizio: now.toISOString(),
                    dataAggiornamento: now.toISOString()
                };
                
                // Aggiorna stato macchina
                $(`#machine-${selectedMachine}`).find(".badge-status")
                    .removeClass("bg-success")
                    .addClass("bg-danger")
                    .text("In uso");
                
                // Aggiorna statistiche
                stats.concentrato += quantita;
                stats.processiAttivi++;
                updateStats();
                
                // Aggiorna tabella
                updateConcentrazioneTable();
                
                // Reset form e selezione
                $("#concentrazione-form")[0].reset();
                $("[id^='conc-altro-'][id$='-container']").hide();
                $("#concentratori-content .machine-card").removeClass("selected");
                selectedMachine = null;
                selectedMachineType = null;
                
                alert("Processo di concentrazione avviato con successo!");
            });
            
            // Avvio processo di distillazione
            $("#distillazione-form").submit(function(e) {
                e.preventDefault();
                
                console.log("Form distillazione inviato");
                
                // Verifica che sia stata selezionata una macchina
                if (!selectedMachine || selectedMachineType !== "distillatore") {
                    alert("Seleziona un impianto di distillazione!");
                    return;
                }
                
                // Raccolta dati
                let tipoProdotto = $("#dist-tipo-prodotto").val();
                if (tipoProdotto === "Altro") {
                    tipoProdotto = $("#dist-altro-prodotto").val();
                    if (!tipoProdotto) {
                        alert("Specifica il tipo di prodotto!");
                        return;
                    }
                }
                
                let serbatoio = $("#dist-serbatoio").val();
                if (!serbatoio) {
                    alert("Seleziona un serbatoio!");
                    return;
                }
                
                let tipoAgrume = $("#dist-tipo-agrume").val();
                if (tipoAgrume === "Altro") {
                    tipoAgrume = $("#dist-altro-agrume").val();
                    if (!tipoAgrume) {
                        alert("Specifica il tipo di agrume!");
                        return;
                    }
                }
                
                let certificazione = $("#dist-certificazione").val();
                if (certificazione === "ALTRO") {
                    certificazione = $("#dist-altra-certificazione").val();
                    if (!certificazione) {
                        alert("Specifica la certificazione!");
                        return;
                    }
                }
                
                let lineaTrasformazione = $("#dist-linea-trasformazione").val();
                if (lineaTrasformazione === "ALTRA") {
                    lineaTrasformazione = $("#dist-altra-linea").val();
                    if (!lineaTrasformazione) {
                        alert("Specifica la linea di trasformazione!");
                        return;
                    }
                }
                
                let tenorePolpa = $("#dist-tenore-polpa").val();
                if (tenorePolpa === "Altro") {
                    tenorePolpa = $("#dist-altro-tenore").val();
                    if (!tenorePolpa) {
                        alert("Specifica il tenore di polpa!");
                        return;
                    }
                }
                
                const quantita = parseInt($("#dist-quantita").val());
                const note = $("#dist-note").val();
                
                // Validazione 
                if (!tipoProdotto || !tipoAgrume || !certificazione || 
                    !lineaTrasformazione || !tenorePolpa || isNaN(quantita)) {
                    alert("Compila tutti i campi obbligatori con valori validi!");
                    return;
                }
                
                // Generazione ID processo
                const now = new Date();
                const processId = "DIST-" + now.getFullYear() + 
                               padZero(now.getMonth() + 1) + 
                               padZero(now.getDate()) + "-" + 
                               padZero(now.getHours()) + 
                               padZero(now.getMinutes()) +
                               padZero(now.getSeconds());
                
                console.log("Creazione processo:", processId);
                
                // Creazione oggetto processo
                processi.distillazione[processId] = {
                    id: processId,
                    macchina: selectedMachine,
                    serbatoio: serbatoio,
                    tipoProdotto: tipoProdotto,
                    tipoAgrume: tipoAgrume,
                    certificazione: certificazione,
                    lineaTrasformazione: lineaTrasformazione,
                    tenorePolpa: tenorePolpa,
                    quantita: quantita,
                    note: note,
                    stato: "In corso",
                    avanzamento: 0,
                    dataInizio: now.toISOString(),
                    dataAggiornamento: now.toISOString()
                };
                
                // Aggiorna stato macchina
                $(`#machine-${selectedMachine}`).find(".badge-status")
                    .removeClass("bg-success")
                    .addClass("bg-danger")
                    .text("In uso");
                
                // Aggiorna statistiche
                stats.distillato += quantita;
                stats.processiAttivi++;
                updateStats();
                
                // Aggiorna tabella
                updateDistillazioneTable();
                
                // Reset form e selezione
                $("#distillazione-form")[0].reset();
                $("[id^='dist-altro-'][id$='-container']").hide();
                $("#distillatori-content .machine-card").removeClass("selected");
                selectedMachine = null;
                selectedMachineType = null;
                
                alert("Processo di distillazione avviato con successo!");
            });
            
            // Avvio processo di pastorizzazione
            $("#pastorizzazione-form").submit(function(e) {
                e.preventDefault();
                
                console.log("Form pastorizzazione inviato");
                
                // Verifica che sia stata selezionata una macchina
                if (!selectedMachine || selectedMachineType !== "pastorizzatore") {
                    alert("Seleziona un impianto di pastorizzazione!");
                    return;
                }
                
                // Raccolta dati
                let tipoProdotto = $("#past-tipo-prodotto").val();
                if (tipoProdotto === "Altro") {
                    tipoProdotto = $("#past-altro-prodotto").val();
                    if (!tipoProdotto) {
                        alert("Specifica il tipo di prodotto!");
                        return;
                    }
                }
                
                let serbatoio = $("#past-serbatoio").val();
                if (!serbatoio) {
                    alert("Seleziona un serbatoio!");
                    return;
                }
                
                let tipoAgrume = $("#past-tipo-agrume").val();
                if (tipoAgrume === "Altro") {
                    tipoAgrume = $("#past-altro-agrume").val();
                    if (!tipoAgrume) {
                        alert("Specifica il tipo di agrume!");
                        return;
                    }
                }
                
                let certificazione = $("#past-certificazione").val();
                if (certificazione === "ALTRO") {
                    certificazione = $("#past-altra-certificazione").val();
                    if (!certificazione) {
                        alert("Specifica la certificazione!");
                        return;
                    }
                }
                
                let lineaTrasformazione = $("#past-linea-trasformazione").val();
                if (lineaTrasformazione === "ALTRA") {
                    lineaTrasformazione = $("#past-altra-linea").val();
                    if (!lineaTrasformazione) {
                        alert("Specifica la linea di trasformazione!");
                        return;
                    }
                }
                
                let tenorePolpa = $("#past-tenore-polpa").val();
                if (tenorePolpa === "Altro") {
                    tenorePolpa = $("#past-altro-tenore").val();
                    if (!tenorePolpa) {
                        alert("Specifica il tenore di polpa!");
                        return;
                    }
                }
                
                const quantita = parseInt($("#past-quantita").val());
                const temperatura = parseFloat($("#past-temperatura").val());
                const tempo = parseFloat($("#past-tempo").val());
                const note = $("#past-note").val();
                
                // Validazione 
                if (!tipoProdotto || !tipoAgrume || !certificazione || 
                    !lineaTrasformazione || !tenorePolpa || isNaN(quantita) || 
                    isNaN(temperatura) || isNaN(tempo)) {
                    alert("Compila tutti i campi obbligatori con valori validi!");
                    return;
                }
                
                // Generazione ID processo
                const now = new Date();
                const processId = "PAST-" + now.getFullYear() + 
                               padZero(now.getMonth() + 1) + 
                               padZero(now.getDate()) + "-" + 
                               padZero(now.getHours()) + 
                               padZero(now.getMinutes()) +
                               padZero(now.getSeconds());
                
                console.log("Creazione processo:", processId);
                
                // Creazione oggetto processo
                processi.pastorizzazione[processId] = {
                    id: processId,
                    macchina: selectedMachine,
                    serbatoio: serbatoio,
                    tipoProdotto: tipoProdotto,
                    tipoAgrume: tipoAgrume,
                    certificazione: certificazione,
                    lineaTrasformazione: lineaTrasformazione,
                    tenorePolpa: tenorePolpa,
                    quantita: quantita,
                    temperatura: temperatura,
                    tempo: tempo,
                    note: note,
                    stato: "In corso",
                    avanzamento: 0,
                    dataInizio: now.toISOString(),
                    dataAggiornamento: now.toISOString()
                };
                
                // Aggiorna stato macchina
                $(`#machine-${selectedMachine}`).find(".badge-status")
                    .removeClass("bg-success")
                    .addClass("bg-danger")
                    .text("In uso");
                
                // Aggiorna statistiche
                stats.pastorizzato += quantita;
                stats.processiAttivi++;
                updateStats();
                
                // Aggiorna tabella
                updatePastorizzazioneTable();
                
                // Reset form e selezione
                $("#pastorizzazione-form")[0].reset();
                $("[id^='past-altro-'][id$='-container']").hide();
                $("#pastorizzatori-content .machine-card").removeClass("selected");
                selectedMachine = null;
                selectedMachineType = null;
                
                alert("Processo di pastorizzazione avviato con successo!");
            });
            
            // Gestione modal processo
            $(document).on("click", ".view-process", function() {
                const processId = $(this).data("processid");
                const processType = $(this).data("processtype");
                
                // Memorizza l'ID e il tipo di processo corrente
                currentProcessId = {
                    id: processId,
                    type: processType
                };
                
                // Recupera i dati del processo
                let processo = null;
                
                if (processType === "concentrazione") {
                    processo = processi.concentrazione[processId];
                } else if (processType === "distillazione") {
                    processo = processi.distillazione[processId];
                } else if (processType === "pastorizzazione") {
                    processo = processi.pastorizzazione[processId];
                }
                
                if (!processo) {
                    alert("Errore: processo non trovato!");
                    return;
                }
                
                // Popola il modal con i dati del processo
                $("#processo-id").text(processo.id);
                $("#modal-macchina").text(processo.macchina);
                $("#modal-serbatoio").text(processo.serbatoio);
                $("#modal-prodotto").text(processo.tipoProdotto);
                $("#modal-agrume").text(processo.tipoAgrume);
                $("#modal-certificazione").text(processo.certificazione);
                $("#modal-quantita").text(processo.quantita + " L");
                $("#modal-linea").text(processo.lineaTrasformazione);
                $("#modal-data-inizio").text(new Date(processo.dataInizio).toLocaleString());
                $("#modal-note").text(processo.note || "Nessuna nota");
                
                // Imposta lo stato e l'avanzamento attuali
                $("#modal-stato").val(processo.stato);
                $("#modal-avanzamento").val(processo.avanzamento);
                $("#modal-avanzamento-valore").text(processo.avanzamento + "%");
                
                // Apri il modal
                new bootstrap.Modal(document.getElementById('processoModal')).show();
            });
            
            // Aggiornamento valore slider avanzamento
            $("#modal-avanzamento").on("input", function() {
                $("#modal-avanzamento-valore").text($(this).val() + "%");
            });
            
            // Salvataggio modifiche dal modal
            $("#btn-save-process").click(function() {
                if (!currentProcessId) {
                    alert("Errore: nessun processo selezionato!");
                    return;
                }
                
                const { id, type } = currentProcessId;
                let processo = null;
                
                if (type === "concentrazione") {
                    processo = processi.concentrazione[id];
                } else if (type === "distillazione") {
                    processo = processi.distillazione[id];
                } else if (type === "pastorizzazione") {
                    processo = processi.pastorizzazione[id];
                }
                
                if (!processo) {
                    alert("Errore: processo non trovato!");
                    return;
                }
                
                // Recupera i nuovi valori
                const nuovoStato = $("#modal-stato").val();
                const nuovoAvanzamento = parseInt($("#modal-avanzamento").val());
                const noteAggiuntive = $("#modal-note-aggiuntive").val();
                
                // Aggiorna il processo
                processo.stato = nuovoStato;
                processo.avanzamento = nuovoAvanzamento;
                
                if (noteAggiuntive) {
                    if (processo.note) {
                        processo.note += "\n\n" + noteAggiuntive;
                    } else {
                        processo.note = noteAggiuntive;
                    }
                }
                
                processo.dataAggiornamento = new Date().toISOString();
                
                // Se il processo è completato o interrotto, libera la macchina
                if (nuovoStato === "Completato" || nuovoStato === "Interrotto") {
                    $(`#machine-${processo.macchina}`).find(".badge-status")
                        .removeClass("bg-danger")
                        .addClass("bg-success")
                        .text("Disponibile");
                    
                    stats.processiAttivi--;
                }
                
                // Chiudi il modal
                const modalEl = document.getElementById('processoModal');
                const modal = bootstrap.Modal.getInstance(modalEl);
                modal.hide();
                
                // Aggiorna le tabelle e le statistiche
                if (type === "concentrazione") {
                    updateConcentrazioneTable();
                } else if (type === "distillazione") {
                    updateDistillazioneTable();
                } else if (type === "pastorizzazione") {
                    updatePastorizzazioneTable();
                }
                
                updateStats();
                
                // Reset
                $("#modal-note-aggiuntive").val("");
                currentProcessId = null;
                
                alert("Modifiche salvate con successo!");
            });
            
            // Simulazione collegamento ad altri reparti
            $("#btn-reparto-1").click(function() {
                if (confirm("Passare al Reparto 1: Ricezione e scarico frutta? Le modifiche non salvate andranno perse.")) {
                    alert("Collegamento al Reparto 1 simulato.");
                }
            });
            
            $("#btn-reparto-2").click(function() {
                if (confirm("Passare al Reparto 2: Trasformazione? Le modifiche non salvate andranno perse.")) {
                    alert("Collegamento al Reparto 2 simulato.");
                }
            });
            
            // FUNZIONI DI SUPPORTO
            
            // Aggiornamento tabella concentrazione
            function updateConcentrazioneTable() {
                const tableBody = $("#concentrazione-processi");
                tableBody.empty();
                
                let hasProcesses = false;
                
                for (const processId in processi.concentrazione) {
                    const processo = processi.concentrazione[processId];
                    hasProcesses = true;
                    
                    let statoClass = "";
                    switch(processo.stato) {
                        case "In corso":
                            statoClass = "bg-primary text-white";
                            break;
                        case "Completato":
                            statoClass = "bg-success text-white";
                            break;
                        case "Interrotto":
                            statoClass = "bg-danger text-white";
                            break;
                        case "In pausa":
                            statoClass = "bg-warning";
                            break;
                    }
                    
                    tableBody.append(`
                        <tr>
                            <td>${processo.id}</td>
                            <td>${processo.macchina}</td>
                            <td>${processo.serbatoio}</td>
                            <td>${processo.tipoProdotto}</td>
                            <td>${processo.tipoAgrume}</td>
                            <td>${processo.certificazione}</td>
                            <td>${processo.quantita} L</td>
                            <td>${processo.brixTarget}</td>
                            <td class="${statoClass}">${processo.stato} (${processo.avanzamento}%)</td>
                            <td>
                                <button class="btn btn-sm btn-info view-process" data-processid="${processo.id}" data-processtype="concentrazione">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </td>
                        </tr>
                    `);
                }
                
                if (!hasProcesses) {
                    tableBody.append(`
                        <tr>
                            <td colspan="10" class="text-center">Nessun processo attivo</td>
                        </tr>
                    `);
                }
            }
            
            // Aggiornamento tabella distillazione
            function updateDistillazioneTable() {
                const tableBody = $("#distillazione-processi");
                tableBody.empty();
                
                let hasProcesses = false;
                
                for (const processId in processi.distillazione) {
                    const processo = processi.distillazione[processId];
                    hasProcesses = true;
                    
                    let statoClass = "";
                    switch(processo.stato) {
                        case "In corso":
                            statoClass = "bg-primary text-white";
                            break;
                        case "Completato":
                            statoClass = "bg-success text-white";
                            break;
                        case "Interrotto":
                            statoClass = "bg-danger text-white";
                            break;
                        case "In pausa":
                            statoClass = "bg-warning";
                            break;
                    }
                    
                    tableBody.append(`
                        <tr>
                            <td>${processo.id}</td>
                            <td>${processo.macchina}</td>
                            <td>${processo.serbatoio}</td>
                            <td>${processo.tipoProdotto}</td>
                            <td>${processo.tipoAgrume}</td>
                            <td>${processo.certificazione}</td>
                            <td>${processo.quantita} L</td>
                            <td class="${statoClass}">${processo.stato} (${processo.avanzamento}%)</td>
                            <td>
                                <button class="btn btn-sm btn-info view-process" data-processid="${processo.id}" data-processtype="distillazione">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </td>
                        </tr>
                    `);
                }
                
                if (!hasProcesses) {
                    tableBody.append(`
                        <tr>
                            <td colspan="9" class="text-center">Nessun processo attivo</td>
                        </tr>
                    `);
                }
            }
            
            // Aggiornamento tabella pastorizzazione
            function updatePastorizzazioneTable() {
                const tableBody = $("#pastorizzazione-processi");
                tableBody.empty();
                
                let hasProcesses = false;
                
                for (const processId in processi.pastorizzazione) {
                    const processo = processi.pastorizzazione[processId];
                    hasProcesses = true;
                    
                    let statoClass = "";
                    switch(processo.stato) {
                        case "In corso":
                            statoClass = "bg-primary text-white";
                            break;
                        case "Completato":
                            statoClass = "bg-success text-white";
                            break;
                        case "Interrotto":
                            statoClass = "bg-danger text-white";
                            break;
                        case "In pausa":
                            statoClass = "bg-warning";
                            break;
                    }
                    
                    tableBody.append(`
                        <tr>
                            <td>${processo.id}</td>
                            <td>${processo.macchina}</td>
                            <td>${processo.serbatoio}</td>
                            <td>${processo.tipoProdotto}</td>
                            <td>${processo.tipoAgrume}</td>
                            <td>${processo.certificazione}</td>
                            <td>${processo.quantita} L</td>
                            <td>${processo.temperatura} °C</td>
                            <td>${processo.tempo} min</td>
                            <td class="${statoClass}">${processo.stato} (${processo.avanzamento}%)</td>
                            <td>
                                <button class="btn btn-sm btn-info view-process" data-processid="${processo.id}" data-processtype="pastorizzazione">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </td>
                        </tr>
                    `);
                }
                
                if (!hasProcesses) {
                    tableBody.append(`
                        <tr>
                            <td colspan="11" class="text-center">Nessun processo attivo</td>
                        </tr>
                    `);
                }
            }
            
            // Aggiornamento statistiche
            function updateStats() {
                $("#total-concentrato").text(stats.concentrato + " L");
                $("#total-distillato").text(stats.distillato + " L");
                $("#total-pastorizzato").text(stats.pastorizzato + " L");
                $("#processi-attivi").text(stats.processiAttivi);
            }
            
            // Utility per padding zeri
            function padZero(num) {
                return num < 10 ? "0" + num : num;
            }
            
            console.log("Script inizializzato");
        });
    </script>
</body>
</html>
